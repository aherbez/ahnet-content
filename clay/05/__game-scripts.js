var ClayObj=pc.createScript("clayObj");ClayObj.prototype.initialize=function(){console.log("new clay! lets get started!"),this.node=new pc.GraphNode,this.entity.addChild(this.node),this.material=new pc.StandardMaterial,this.material.diffuse.set(0,1,0);let t=this.app.assets.find("clayMat");t&&(this.material=t.resource),this.sweepAngle=360,this.initPoints(),this.initCursor(),this.app.keyboard.on(pc.EVENT_KEYDOWN,this.onKeyDown,this)},ClayObj.prototype.onKeyDown=function(t){t.key===pc.KEY_UP&&(this.cursorY+=.01,this.cursorY>1&&(this.cursorY=1),this.updateCursorPosition()),t.key===pc.KEY_DOWN&&(this.cursorY-=.01,this.cursorY<0&&(this.cursorY=0),this.updateCursorPosition()),t.key===pc.KEY_Q&&(this.radius-=.1,this.updateCursorPosition()),t.key===pc.KEY_E&&(this.radius+=.1,this.updateCursorPosition()),t.key===pc.KEY_S&&this.alterObj(-1),t.key===pc.KEY_D&&this.alterObj(1),t.event.preventDefault()},ClayObj.prototype.initCursor=function(){this.updateSegLengths();let t=this.entity.find("name","cursor");this.cursor=t[0],this.cursor.setLocalPosition(1,1,1),this.cursorY=.8,this.cursorX=0,this.radius=.4,this.updateCursorPosition()},ClayObj.prototype.updateSegLengths=function(){this.segLengths=[0];let t=0;this.pathPoints.forEach(((s,e)=>{if(e>0){let i=s.clone().sub(this.pathPoints[e-1]).length();t+=i,this.segLengths.push(t)}})),this.segLengths=this.segLengths.map((s=>s/t))},ClayObj.prototype.updateCursorPosition=function(){let t=1;for(;t<this.segLengths.length&&this.segLengths[t]<this.cursorY;)t++;let s=t-1,e=(this.cursorY-this.segLengths[s])/(this.segLengths[t]-this.segLengths[s]),i=this.pathPoints[s].clone().mulScalar(1-e),o=this.pathPoints[t].clone().mulScalar(e).add(i);this.cursor.setPosition(o);let n=2*this.radius;this.cursor.setLocalScale(n,n,n)},ClayObj.prototype.initPoints=function(){this.pathPoints=[],this.prevPoints=[],this.pathPoints.push(new pc.Vec3(0,0,0)),this.pathPoints.push(new pc.Vec3(1.5,0,0));let t=Math.PI/2/10;for(let s=0;s<10;s++)console.log(t),this.pathPoints.push(new pc.Vec3(3*Math.cos(t*s)/2,1.2*Math.sin(t*s),0));this.pathPoints.push(new pc.Vec3(0,1.2,0)),this.updateVerts()},ClayObj.prototype.revolvePoints=function(t,s,e){const i=t.length;let o=[],n=[],h=[],r=e-s;const l=Math.max(Math.ceil(r/18),2);for(let e=0;e<l;e++){let i=r/(l-1)*e+s,h=(new pc.Mat4).setFromEulerAngles(0,i,0);t.forEach(((s,i)=>{let r=s.clone();r=h.transformVector(r),o.push(r.x,r.y,r.z),n.push(e/(l-1),i/(t.length-1))}))}const a=r<360?l-1:l;for(let t=0;t<l;t++)for(let s=0;s<i;s++)if(s<i-1&&t<a){let e=t*i,o=(t+1)%l*i,n=(s+1)%i,r=e+s,a=e+n,c=o+s,p=o+n;h.push(r,p,a),h.push(r,c,p)}normals=pc.calculateNormals(o,h);var c={normals:normals,uvs:n,indices:h};let p=pc.createMesh(this.app.graphicsDevice,o,c);return new pc.MeshInstance(this.node,p,this.material)},ClayObj.prototype.updateVerts=function(){this.model&&this.app.scene.removeModel(this.model);let t=this.revolvePoints(this.pathPoints,0,this.sweepAngle);if(this.model=new pc.Model,this.model.graph=this.node,this.model.meshInstances=[t],this.app.scene.addModel(this.model),this.oldModel&&this.app.scene.removeModel(this.oldModel),this.sweepAngle<360){let t=this.revolvePoints(this.prevPoints,this.sweepAngle,360);this.oldModel=new pc.Model,this.oldModel.graph=this.node,this.oldModel.meshInstances=[t],this.app.scene.addModel(this.oldModel)}},ClayObj.prototype.segmentCircleIntersection=function(t,s,e,i){const dot=function(t,s){return t.x*s.x+t.y*s.y};let o=s.clone().sub(t),n=dot(o,o),h=t.clone().sub(e),r=dot(h,o),l=dot(h,h)-i*i;if(0==n)return console.error("AA = 0!"),null;let a=r*r-n*l;if(a<0)return console.log("no intersection"),null;let c=(-r-Math.sqrt(a))/n;return t.clone().add(o.mulScalar(c))},ClayObj.prototype.isLeft=function(t,s,e){return(s.x-t.x)*(e.y-t.y)-(s.y-t.y)*(e.x-t.x)},ClayObj.prototype.genCirclePoints=function(t,s,e,i,o){let n=t.clone().sub(e),h=Math.atan2(n.y,n.x),r=s.clone().sub(e),l=Math.atan2(r.y,r.x),a=(l-h)/8*o,c=new pc.Vec3(Math.cos(h+a)*i,Math.sin(h+a)*i,0),p=this.isLeft(t,s,c);console.log({start:h,endTheta:l,isLeft:p,direction:o,slice:a});const sign=function(t){return t>0};sign(a)!==sign(o)&&(a*=-1);let u=2*Math.PI,d=h+a,g=[];for(let t=1;t<7;t++){let t=new pc.Vec3(Math.cos(d)*i,Math.sin(d)*i,0).add(e);g.push(t),d+=a,d<0&&(d+=u),d>u&&(d-=u)}return g},ClayObj.prototype.alterObj=function(t){this.prevPoints=this.pathPoints.slice();const s=new pc.Vec3(1,1,0),e=this.radius*this.radius;let i=this.cursor.getLocalPosition().clone().mul(s),o=this.pathPoints.map((t=>t.clone().sub(i).mul(s).lengthSq())),n=[],h=!1,r=null;if(this.pathPoints.forEach(((s,l)=>{if(o[l]>e){if(h){let s=this.segmentCircleIntersection(this.pathPoints[l],this.pathPoints[l-1],i,this.radius),e=this.genCirclePoints(r,s,i,this.radius,t);n.push(...e),n.push(s),r=null}n.push(s),h=!1}else h||(r=this.segmentCircleIntersection(this.pathPoints[l-1],this.pathPoints[l],i,this.radius),n.push(r)),h=!0})),r){let s=t>0?100:-100,e=this.segmentCircleIntersection(new pc.Vec3(0,i.y+s,0),new pc.Vec3(0,i.y,0),i,this.radius),o=this.genCirclePoints(r,e,i,this.radius,t);n.push(...o),n.push(e)}this.pathPoints=n,this.sweepAngle=0,this.updateVerts(),this.updateSegLengths(),this.updateCursorPosition()},ClayObj.prototype.update=function(t){this.sweepAngle<360&&(this.sweepAngle=Math.min(this.sweepAngle+720*t,360),this.updateVerts())};var OrbitCamera=pc.createScript("orbitCamera");OrbitCamera.attributes.add("distanceMax",{type:"number",default:0,title:"Distance Max",description:"Setting this at 0 will give an infinite distance limit"}),OrbitCamera.attributes.add("distanceMin",{type:"number",default:0,title:"Distance Min"}),OrbitCamera.attributes.add("pitchAngleMax",{type:"number",default:90,title:"Pitch Angle Max (degrees)"}),OrbitCamera.attributes.add("pitchAngleMin",{type:"number",default:-90,title:"Pitch Angle Min (degrees)"}),OrbitCamera.attributes.add("inertiaFactor",{type:"number",default:0,title:"Inertia Factor",description:"Higher value means that the camera will continue moving after the user has stopped dragging. 0 is fully responsive."}),OrbitCamera.attributes.add("focusEntity",{type:"entity",title:"Focus Entity",description:"Entity for the camera to focus on. If blank, then the camera will use the whole scene"}),OrbitCamera.attributes.add("frameOnStart",{type:"boolean",default:!0,title:"Frame on Start",description:'Frames the entity or scene at the start of the application."'}),Object.defineProperty(OrbitCamera.prototype,"distance",{get:function(){return this._targetDistance},set:function(t){this._targetDistance=this._clampDistance(t)}}),Object.defineProperty(OrbitCamera.prototype,"pitch",{get:function(){return this._targetPitch},set:function(t){this._targetPitch=this._clampPitchAngle(t)}}),Object.defineProperty(OrbitCamera.prototype,"yaw",{get:function(){return this._targetYaw},set:function(t){this._targetYaw=t;var i=(this._targetYaw-this._yaw)%360;this._targetYaw=i>180?this._yaw-(360-i):i<-180?this._yaw+(360+i):this._yaw+i}}),Object.defineProperty(OrbitCamera.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(t){this._pivotPoint.copy(t)}}),OrbitCamera.prototype.focus=function(t){this._buildAabb(t,0);var i=this._modelsAabb.halfExtents,e=Math.max(i.x,Math.max(i.y,i.z));e/=Math.tan(.5*this.entity.camera.fov*pc.math.DEG_TO_RAD),e*=2,this.distance=e,this._removeInertia(),this._pivotPoint.copy(this._modelsAabb.center)},OrbitCamera.distanceBetween=new pc.Vec3,OrbitCamera.prototype.resetAndLookAtPoint=function(t,i){this.pivotPoint.copy(i),this.entity.setPosition(t),this.entity.lookAt(i);var e=OrbitCamera.distanceBetween;e.sub2(i,t),this.distance=e.length(),this.pivotPoint.copy(i);var a=this.entity.getRotation();this.yaw=this._calcYaw(a),this.pitch=this._calcPitch(a,this.yaw),this._removeInertia(),this._updatePosition()},OrbitCamera.prototype.resetAndLookAtEntity=function(t,i){this._buildAabb(i,0),this.resetAndLookAtPoint(t,this._modelsAabb.center)},OrbitCamera.prototype.reset=function(t,i,e){this.pitch=i,this.yaw=t,this.distance=e,this._removeInertia()},OrbitCamera.prototype.initialize=function(){var t=this,onWindowResize=function(){t._checkAspectRatio()};window.addEventListener("resize",onWindowResize,!1),this._checkAspectRatio(),this._modelsAabb=new pc.BoundingBox,this._buildAabb(this.focusEntity||this.app.root,0),this.entity.lookAt(this._modelsAabb.center),this._pivotPoint=new pc.Vec3,this._pivotPoint.copy(this._modelsAabb.center);var i=this.entity.getRotation();if(this._yaw=this._calcYaw(i),this._pitch=this._clampPitchAngle(this._calcPitch(i,this._yaw)),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._distance=0,this._targetYaw=this._yaw,this._targetPitch=this._pitch,this.frameOnStart)this.focus(this.focusEntity||this.app.root);else{var e=new pc.Vec3;e.sub2(this.entity.getPosition(),this._pivotPoint),this._distance=this._clampDistance(e.length())}this._targetDistance=this._distance,this.on("attr:distanceMin",(function(t,i){this._targetDistance=this._clampDistance(this._distance)})),this.on("attr:distanceMax",(function(t,i){this._targetDistance=this._clampDistance(this._distance)})),this.on("attr:pitchAngleMin",(function(t,i){this._targetPitch=this._clampPitchAngle(this._pitch)})),this.on("attr:pitchAngleMax",(function(t,i){this._targetPitch=this._clampPitchAngle(this._pitch)})),this.on("attr:focusEntity",(function(t,i){this.frameOnStart?this.focus(t||this.app.root):this.resetAndLookAtEntity(this.entity.getPosition(),t||this.app.root)})),this.on("attr:frameOnStart",(function(t,i){t&&this.focus(this.focusEntity||this.app.root)})),this.on("destroy",(function(){window.removeEventListener("resize",onWindowResize,!1)}))},OrbitCamera.prototype.update=function(t){var i=0===this.inertiaFactor?1:Math.min(t/this.inertiaFactor,1);this._distance=pc.math.lerp(this._distance,this._targetDistance,i),this._yaw=pc.math.lerp(this._yaw,this._targetYaw,i),this._pitch=pc.math.lerp(this._pitch,this._targetPitch,i),this._updatePosition()},OrbitCamera.prototype._updatePosition=function(){this.entity.setLocalPosition(0,0,0),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0);var t=this.entity.getPosition();t.copy(this.entity.forward),t.scale(-this._distance),t.add(this.pivotPoint),this.entity.setPosition(t)},OrbitCamera.prototype._removeInertia=function(){this._yaw=this._targetYaw,this._pitch=this._targetPitch,this._distance=this._targetDistance},OrbitCamera.prototype._checkAspectRatio=function(){var t=this.app.graphicsDevice.height,i=this.app.graphicsDevice.width;this.entity.camera.horizontalFov=t>i},OrbitCamera.prototype._buildAabb=function(t,i){var e,a=0,n=0;if(t instanceof pc.Entity){var s=[],r=t.findComponents("render");for(a=0;a<r.length;++a)for(e=r[a].meshInstances,n=0;n<e.length;n++)s.push(e[n]);var h=t.findComponents("model");for(a=0;a<h.length;++a)for(e=h[a].meshInstances,n=0;n<e.length;n++)s.push(e[n]);for(a=0;a<s.length;a++)0===i?this._modelsAabb.copy(s[a].aabb):this._modelsAabb.add(s[a].aabb),i+=1}for(a=0;a<t.children.length;++a)i+=this._buildAabb(t.children[a],i);return i},OrbitCamera.prototype._calcYaw=function(t){var i=new pc.Vec3;return t.transformVector(pc.Vec3.FORWARD,i),Math.atan2(-i.x,-i.z)*pc.math.RAD_TO_DEG},OrbitCamera.prototype._clampDistance=function(t){return this.distanceMax>0?pc.math.clamp(t,this.distanceMin,this.distanceMax):Math.max(t,this.distanceMin)},OrbitCamera.prototype._clampPitchAngle=function(t){return pc.math.clamp(t,-this.pitchAngleMax,-this.pitchAngleMin)},OrbitCamera.quatWithoutYaw=new pc.Quat,OrbitCamera.yawOffset=new pc.Quat,OrbitCamera.prototype._calcPitch=function(t,i){var e=OrbitCamera.quatWithoutYaw,a=OrbitCamera.yawOffset;a.setFromEulerAngles(0,-i,0),e.mul2(a,t);var n=new pc.Vec3;return e.transformVector(pc.Vec3.FORWARD,n),Math.atan2(n.y,-n.z)*pc.math.RAD_TO_DEG};var MouseInput=pc.createScript("mouseInput");MouseInput.attributes.add("orbitSensitivity",{type:"number",default:.3,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"}),MouseInput.attributes.add("distanceSensitivity",{type:"number",default:.15,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"}),MouseInput.prototype.initialize=function(){if(this.orbitCamera=this.entity.script.orbitCamera,this.orbitCamera){var t=this,onMouseOut=function(o){t.onMouseOut(o)};this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this),window.addEventListener("mouseout",onMouseOut,!1),this.on("destroy",(function(){this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.off(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.off(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this),window.removeEventListener("mouseout",onMouseOut,!1)}))}this.app.mouse.disableContextMenu(),this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new pc.Vec2},MouseInput.fromWorldPoint=new pc.Vec3,MouseInput.toWorldPoint=new pc.Vec3,MouseInput.worldDiff=new pc.Vec3,MouseInput.prototype.pan=function(t){var o=MouseInput.fromWorldPoint,e=MouseInput.toWorldPoint,i=MouseInput.worldDiff,s=this.entity.camera,n=this.orbitCamera.distance;s.screenToWorld(t.x,t.y,n,o),s.screenToWorld(this.lastPoint.x,this.lastPoint.y,n,e),i.sub2(e,o),this.orbitCamera.pivotPoint.add(i)},MouseInput.prototype.onMouseDown=function(t){switch(t.button){case pc.MOUSEBUTTON_LEFT:this.lookButtonDown=!0;break;case pc.MOUSEBUTTON_MIDDLE:case pc.MOUSEBUTTON_RIGHT:this.panButtonDown=!0}},MouseInput.prototype.onMouseUp=function(t){switch(t.button){case pc.MOUSEBUTTON_LEFT:this.lookButtonDown=!1;break;case pc.MOUSEBUTTON_MIDDLE:case pc.MOUSEBUTTON_RIGHT:this.panButtonDown=!1}},MouseInput.prototype.onMouseMove=function(t){pc.app.mouse;this.lookButtonDown?(this.orbitCamera.pitch-=t.dy*this.orbitSensitivity,this.orbitCamera.yaw-=t.dx*this.orbitSensitivity):this.panButtonDown&&this.pan(t),this.lastPoint.set(t.x,t.y)},MouseInput.prototype.onMouseWheel=function(t){this.orbitCamera.distance-=t.wheel*this.distanceSensitivity*(.1*this.orbitCamera.distance),t.event.preventDefault()},MouseInput.prototype.onMouseOut=function(t){this.lookButtonDown=!1,this.panButtonDown=!1};